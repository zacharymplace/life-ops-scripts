name: Stale Branches Report

on:
  schedule:
    - cron: "12 14 * * 1"   # Mondays 14:12 UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
        - name: Generate report
        id: gen
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const defaultBranch = (await github.rest.repos.get({ owner, repo })).data.default_branch;

            // Only include branches with a PR merged into default > N days ago
            const mergedOlderThanDays = 14;

            // Helper
            const daysBetween = (a, b) => Math.floor((b - a) / 86400000);
            const now = new Date();

            // Fetch up to 200 branches
            const branches = await github.paginate(
              github.rest.repos.listBranches,
              { owner, repo, per_page: 100 }
            );

            const stale = [];
            for (const br of branches) {
              const name = br.name;
              if (name === defaultBranch) continue;

              // Find a closed, merged PR from this branch into default
              const prs = await github.paginate(github.rest.pulls.list, {
                owner, repo, state: 'closed', head: `${owner}:${name}`, per_page: 50
              });
              const mergedPR = prs.find(pr => pr.merged_at && pr.base.ref === defaultBranch);
              if (!mergedPR) continue;

              const mergedAt = new Date(mergedPR.merged_at);
              const age = daysBetween(mergedAt, now);
              if (age <= mergedOlderThanDays) continue; // skip recent merges

              // Last commit date for info (best-effort)
              const sha = br.commit?.sha;
              let lastCommitISO = "unknown";
              try {
                if (sha) {
                  const commit = (await github.rest.repos.getCommit({ owner, repo, ref: sha })).data;
                  lastCommitISO = commit.commit.committer.date.slice(0,10);
                }
              } catch {}

              stale.push({
                name,
                mergedAt: mergedAt.toISOString().slice(0,10),
                age,
                prNumber: mergedPR.number
              });
            }

            // Build markdown
            let body = `## Stale Branches Report (merged > ${mergedOlderThanDays} days)\n` +
                       `Default branch: **${defaultBranch}**  \n` +
                       `Generated: ${now.toISOString().slice(0,10)}\n\n`;

            if (stale.length === 0) {
              body += `No stale branches found 🎉\n`;
            } else {
              body += `| Branch | Merged At | Age (days) | PR | Delete |\n` +
                      `|---|---:|---:|---|---|\n`;
              for (const s of stale) {
                const delURL = `https://github.com/${owner}/${repo}/branches/all?query=${encodeURIComponent(s.name)}`;
                body += `| \`${s.name}\` | ${s.mergedAt} | ${s.age} | #${s.prNumber} | [🗑️ delete](${delURL}) |\n`;
              }
            }

            core.setOutput('body', body);

      - name: Open or update issue
        uses: actions/github-script@v7
        env:
          REPORT_BODY: ${{ toJSON(steps.gen.outputs.body) }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const title = "Stale branches report (weekly)";
            const body  = JSON.parse(process.env.REPORT_BODY); // ✅ safe parse

            // Find existing open issue with same title
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner, repo, state: 'open', per_page: 50
            });
            const existing = issues.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.update({
                owner, repo, issue_number: existing.number, body
              });
              core.info(`Updated issue #${existing.number}`);
            } else {
              const created = await github.rest.issues.create({
                owner, repo, title, body, labels: ["automation"]
              });
              core.info(`Created issue #${created.data.number}`);
            }
